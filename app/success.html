<!DOCTYPE html>
<html lang="en-GB">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>The Hawk Games — Order Confirmation</title>
  <link rel="stylesheet" href="/app/css/checkout.css">
  <meta name="robots" content="noindex">
</head>
<body>
  <canvas id="confetti" aria-hidden="true"></canvas>

  <div class="wrap">
    <div class="card">
      <h1>Order confirmation</h1>

      <div class="row" id="statusRow">
        <span class="badge pending" id="statusBadge">Payment received — assigning tickets…</span>
        <span class="mono small" id="orderRefBadge"></span>
        <button id="copyBtn" class="copy" type="button">Copy ref</button>
      </div>

      <div class="hr"></div>

      <div id="content">
        <div class="checkwrap" aria-live="polite">
          <svg class="tick" viewBox="0 0 48 48" role="img" aria-label="Payment successful">
            <circle cx="24" cy="24" r="20"></circle>
            <path d="M14 24l7 7 14-14"></path>
          </svg>
          <div>
            <p class="lead"><strong>Thanks — your payment was successful.</strong></p>
            <p class="muted">We’re assigning your tickets now. This usually finishes within a few seconds.</p>
          </div>
        </div>

        <div class="hr"></div>

        <p class="small muted" id="reassure" style="display:none">
          This is taking longer than usual. Your payment <em>has</em> been received — our system will finish assigning your tickets shortly.
          You’ll get an email the moment it’s done. You can also find your entries any time below.
        </p>

        <div class="row ctas">
          <a id="accountLink" class="btn primary" href="/app/account.html">View my entries</a>
          <a id="homeLink" class="btn" href="/app/">Back to comps</a>
        </div>

        <div class="hr"></div>

        <!-- Cross-sell (static for now; can be hydrated later) -->
        <div class="promo" aria-label="More to explore">
          <a class="tile" href="/app/">
            <span><b>Spin for instant wins</b><br><span class="small muted">Site credit & prizes — instant</span></span>
            <span class="btn">Play now</span>
          </a>
          <a class="tile" href="/app/">
            <span><b>Browse live competitions</b><br><span class="small muted">Fresh prizes added regularly</span></span>
            <span class="btn">Enter</span>
          </a>
        </div>

        <p class="small muted help">
          Need help? Email <a href="mailto:support@the-hawk-games.co.uk">support@the-hawk-games.co.uk</a>.
        </p>
      </div>
    </div>
  </div>

  <noscript>
    <div class="noscript">Payment received. Please visit <a href="/app/account.html">My Entries</a> to view your tickets.</div>
  </noscript>

  <script type="module">
    const ACCOUNT_URL = "/app/account.html";
    const HOME_URL    = "/app/";

    const qs = new URLSearchParams(location.search);
    const orderRef = qs.get("orderRef") || qs.get("orderreference") || qs.get("order_reference") || qs.get("orderid") || "—";

    const statusBadge   = document.getElementById("statusBadge");
    const orderRefBadge = document.getElementById("orderRefBadge");
    const copyBtn       = document.getElementById("copyBtn");
    const reassure      = document.getElementById("reassure");

    document.getElementById("accountLink").href = ACCOUNT_URL;
    document.getElementById("homeLink").href    = HOME_URL;

    orderRefBadge.textContent = "Ref: " + orderRef;
    try { if (orderRef !== "—") history.replaceState({}, "", location.pathname + "?orderRef=" + encodeURIComponent(orderRef)); } catch {}

    copyBtn.addEventListener("click", async () => {
      try {
        await navigator.clipboard.writeText(orderRef);
        copyBtn.textContent = "Copied";
        setTimeout(()=> copyBtn.textContent = "Copy ref", 1200);
      } catch {}
    });

    // Celebrate immediately (payment accepted)
    fireConfetti(900);
    setTimeout(()=> reassure.style.display = "block", 35000);

    // Optional: wire this later to flip to “Tickets confirmed”
    // window.__ORDER_STATUS_ENDPOINT__ = "/api/orders";
    const endpoint = window.__ORDER_STATUS_ENDPOINT__;
    if (endpoint && orderRef && orderRef !== "—") {
      const poll = async (tries=30) => {
        try {
          const url = `${endpoint.replace(/\/$/,'')}/${encodeURIComponent(orderRef)}`;
          const res = await fetch(url, { headers: { "Accept":"application/json" }});
          if (!res.ok) throw 0;
          const o = await res.json().catch(()=> ({}));
          const s = (o.status || "").toUpperCase();
          if (s === "FULFILLED") {
            statusBadge.textContent = "Tickets confirmed";
            statusBadge.className = "badge good";
            // If you return numbers, you can render them:
            // renderTickets(o.tickets);
            return;
          }
          if (s === "FAILED") {
            statusBadge.textContent = "Order not completed";
            statusBadge.className = "badge pending";
            return;
          }
          if (tries > 0) setTimeout(()=>poll(tries-1), 1200);
        } catch {
          if (tries > 0) setTimeout(()=>poll(tries-1), 1500);
        }
      };
      poll();
    }

    // Brand confetti (tiny, self-contained)
    function fireConfetti(duration=900){
      const c = document.getElementById("confetti");
      const ctx = c.getContext("2d");
      let W = c.width = innerWidth, H = c.height = innerHeight;
      const N = Math.min(140, Math.floor(W/12));
      const parts = Array.from({length:N}, () => ({
        x: Math.random()*W, y: -10-Math.random()*40, r: 3+Math.random()*4,
        vx: -1+Math.random()*2, vy: 2+Math.random()*3, rot: Math.random()*6.28, vr: -0.2+Math.random()*0.4,
        s: Math.random()*0.6+0.4
      }));
      let t0 = performance.now();
      const start = t0;
      const draw = (t)=>{
        const dt = (t - t0); t0 = t;
        ctx.clearRect(0,0,W,H);
        parts.forEach(p=>{
          p.x += p.vx * (dt/16);
          p.y += p.vy * (dt/16);
          p.rot += p.vr * (dt/16);
          if (p.y > H+20) p.y = -10, p.x = Math.random()*W;
          ctx.save();
          ctx.translate(p.x,p.y);
          ctx.rotate(p.rot);
          ctx.globalAlpha = p.s;
          ctx.fillStyle = Math.random()<.5 ? "#E0A94A" : (Math.random()<.75 ? "#FF7A1A" : "#FFFFFF");
          ctx.fillRect(-p.r, -p.r, p.r*2, p.r*0.6);
          ctx.restore();
        });
        if (t - start < duration) requestAnimationFrame(draw); else ctx.clearRect(0,0,W,H);
      };
      requestAnimationFrame(draw);
      addEventListener("resize", ()=>{ W = c.width = innerWidth; H = c.height = innerHeight; });
    }

    function renderTickets(arr){
      if (!Array.isArray(arr) || !arr.length) return;
      const sep = document.createElement("div"); sep.className = "hr";
      const grid = document.createElement("div"); grid.className = "tickets";
      grid.innerHTML = arr.map(n=>`<div class="ticket">#${n}</div>`).join("");
      const card = document.querySelector(".card");
      card.appendChild(sep); card.appendChild(grid);
    }
  </script>
</body>
</html>
