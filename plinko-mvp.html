<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>The Hawk Games — Plinko (MVP v2)</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="On-brand Plinko MVP for The Hawk Games with smooth falling and live RTP.">
  <style>
    :root{
      --bg:#121212;--fg:#f5f5f5;--muted:#bfbfbf;--gold:#e0a94a;--card:#1b1b1b;--border:#2a2a2a;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0}
    body{background:var(--bg);color:var(--fg);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
    .header{display:flex;align-items:center;justify-content:space-between;padding:12px 20px;border-bottom:1px solid var(--border);background:#0e0e0e}
    .brand{color:var(--gold);text-decoration:none;font-weight:700}
    .container{max-width:1150px;margin:24px auto;padding:0 16px;display:grid;grid-template-columns:1fr 340px;gap:20px}
    .panel{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:14px}
    h1,h2,h3{margin:8px 0}
    .muted{color:var(--muted)}
    .controls{display:flex;gap:10px;flex-wrap:wrap;margin-top:10px}
    .btn{background:#222;color:var(--fg);padding:10px 14px;border:1px solid var(--border);border-radius:10px;cursor:pointer}
    .btn:hover{border-color:var(--gold)}
    .btn-primary{background:var(--gold);color:#1a1a1a;border:none}
    .btn-primary:hover{filter:brightness(1.05)}
    .pill{display:inline-block;padding:4px 8px;border:1px solid var(--border);border-radius:999px;color:var(--muted);font-size:12px}
    .board-wrap{position:relative;min-height:640px;display:flex;align-items:center;justify-content:center}
    svg{width:100%;height:auto;max-height:860px;display:block}
    .legend{display:grid;grid-template-columns:1fr auto;row-gap:8px;column-gap:12px;margin-top:10px}
    .legend .slot{display:flex;align-items:center;gap:8px}
    .legend .chip{width:12px;height:12px;border-radius:50%;background:var(--gold)}
    .stat{display:flex;align-items:center;justify-content:space-between;padding:8px;border:1px dashed var(--border);border-radius:10px;margin-top:8px}
    .toast{position:fixed;left:50%;bottom:24px;transform:translateX(-50%);background:#1b1b1b;border:1px solid var(--border);color:var(--fg);padding:10px 14px;border-radius:10px;box-shadow:0 6px 30px rgba(0,0,0,.4);opacity:0;pointer-events:none;transition:opacity .25s, transform .25s}
    .toast.show{opacity:1;transform:translateX(-50%) translateY(-4px)}
    .payout-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:6px;margin-top:10px}
    .payout-card{background:#161616;border:1px solid var(--border);border-radius:10px;padding:8px;text-align:center}
    .payout-card .idx{font-size:12px;color:var(--muted)}
    .payout-card .val{font-weight:700;color:var(--gold)}
    .hr{height:1px;background:linear-gradient(90deg,transparent, var(--border), transparent);margin:12px 0}
    .form{display:grid;grid-template-columns:1fr 1fr;gap:8px;margin-top:10px}
    .form .row{display:flex;gap:6px;align-items:center}
    .form label{font-size:12px;color:var(--muted);width:68px}
    .form input[type="number"]{width:100%;background:#101010;border:1px solid var(--border);color:var(--fg);border-radius:8px;padding:8px}
    .form small{color:var(--muted)}
    @media (max-width:980px){
      .container{grid-template-columns:1fr}
    }
  </style>
</head>
<body>
  <header class="header">
    <a class="brand" href="#">The Hawk Games</a>
    <div class="pill">Plinko — MVP demo (smooth)</div>
  </header>

  <main class="container">
    <section class="panel">
      <h1>Plinko (on-brand, smoother)</h1>
      <p class="muted">Visual demo. In production, the server determines outcomes; the client only renders animation.</p>
      <div class="board-wrap">
        <svg id="plinko" viewBox="0 0 900 980" aria-label="Plinko Board"></svg>
      </div>
      <div class="controls">
        <button id="drop1" class="btn btn-primary">Drop 1</button>
        <button id="drop3" class="btn">Drop 3×</button>
        <button id="reset" class="btn">Reset Board</button>
        <span class="pill" id="stakePill"></span>
        <span class="pill" id="rowsPill"></span>
        <span class="pill" id="rtpPill" title="Expected return per £1 stake from current payouts">RTP: …</span>
      </div>
    </section>

    <aside class="panel">
      <h2>Payouts</h2>
      <div id="payoutGrid" class="payout-grid"></div>
      <div class="hr"></div>

      <h3>Edit prizes</h3>
      <div class="form" id="prizeForm"></div>
      <small>Edits apply instantly. RTP updates live.</small>

      <div class="hr"></div>
      <div class="stat"><span>Total Drops</span><strong id="statDrops">0</strong></div>
      <div class="stat"><span>Total Winnings</span><strong id="statWinnings">£0.00</strong></div>
      <div class="stat"><span>Session RTP</span><strong id="statSessionRTP">0%</strong></div>
      <p class="muted" style="margin-top:8px">Centre slots are more likely. Tune payouts to hit your target RTP.</p>
    </aside>
  </main>

  <div id="toast" class="toast" role="status" aria-live="polite"></div>

  <script>
    // ----- Config (editable via UI for payouts) -----
    const CONFIG = {
      rows: 12,                  // N rows -> N+1 slots
      baseStakeGBP: 1,           // conceptual stake per drop
      payoutsGBP: [0, 0.25, 0.5, 1, 2, 5, 25, 5, 2, 1, 0.5, 0.25, 0], // length N+1
      pegRadius: 7.5,
      ballRadius: 10,
      boardMargin: 70,
      rowGap: 62                 // vertical spacing
    };

    // Elements
    const svg = document.getElementById('plinko');
    const drop1 = document.getElementById('drop1');
    const drop3 = document.getElementById('drop3');
    const resetBtn = document.getElementById('reset');
    const payoutGrid = document.getElementById('payoutGrid');
    const prizeForm = document.getElementById('prizeForm');
    const stakePill = document.getElementById('stakePill');
    const rowsPill = document.getElementById('rowsPill');
    const rtpPill = document.getElementById('rtpPill');
    const toast = document.getElementById('toast');
    const statDrops = document.getElementById('statDrops');
    const statWinnings = document.getElementById('statWinnings');
    const statSessionRTP = document.getElementById('statSessionRTP');

    // Geometry state
    let geo = null;  // computed geometry (colGap, peg & slot positions)
    let busy = false, queue = 0;
    let session = { drops: 0, winnings: 0 };

    // Utils
    const fmtGBP = (n) => '£' + Number(n).toFixed(2);
    function showToast(text){
      toast.textContent = text;
      toast.classList.add('show');
      clearTimeout(showToast._t);
      showToast._t = setTimeout(()=> toast.classList.remove('show'), 1700);
    }

    // --- Math helpers ---
    function nCr(n, r){
      if (r<0 || r>n) return 0;
      if (r===0 || r===n) return 1;
      let res = 1;
      for (let i=1;i<=r;i++){
        res = res * (n - r + i) / i;
      }
      return res;
    }

    function theoreticalRTP(){
      const N = CONFIG.rows;
      const payouts = CONFIG.payoutsGBP;
      const denom = Math.pow(2, N);
      let exp = 0;
      for (let k=0;k<=N;k++){
        const p = nCr(N, k) / denom;
        exp += p * (payouts[k] || 0);
      }
      return exp / CONFIG.baseStakeGBP;
    }

    // --- Geometry (fixed alignment; no left shift) ---
    function computeGeometry(){
      const W = 900, H = 980;
      const N = CONFIG.rows;
      const m = CONFIG.boardMargin;
      const usableWidth = W - 2*m;
      const colGap = usableWidth / (N+1);                 // constant horizontal gap
      const xSlot = (s)=> m + 0.5*colGap + s*colGap;      // slot centres
      const yRow  = (r)=> m + CONFIG.rowGap*(r+1);        // row y
      const xPeg  = (r,j)=> m + 0.5*colGap*(N - r + 1) + j*colGap; // peg centres

      return { W,H,N,m,colGap,xSlot,yRow,xPeg,
               slotsY: m + CONFIG.rowGap*(N+1) + 12 };
    }

    // --- Build SVG board ---
    function buildBoard(){
      geo = computeGeometry();
      while (svg.firstChild) svg.removeChild(svg.firstChild);

      // Background
      const bg = document.createElementNS('http://www.w3.org/2000/svg','rect');
      bg.setAttribute('x', geo.m/2);
      bg.setAttribute('y', geo.m/2);
      bg.setAttribute('width', geo.W - geo.m);
      bg.setAttribute('height', geo.H - geo.m);
      bg.setAttribute('fill', '#0e0e0e');
      bg.setAttribute('stroke', 'var(--border)');
      svg.appendChild(bg);

      // Pegs
      for (let r=0; r<geo.N; r++){
        for (let j=0; j<=r; j++){
          const c = document.createElementNS('http://www.w3.org/2000/svg','circle');
          c.setAttribute('cx', geo.xPeg(r,j));
          c.setAttribute('cy', geo.yRow(r));
          c.setAttribute('r', CONFIG.pegRadius);
          c.setAttribute('fill', 'var(--gold)');
          c.setAttribute('opacity', '0.9');
          svg.appendChild(c);
        }
      }

      // Slots & labels
      for (let s=0; s<=geo.N; s++){
        const x = geo.xSlot(s), w = geo.colGap*0.92;
        const rect = document.createElementNS('http://www.w3.org/2000/svg','rect');
        rect.setAttribute('x', x - w/2);
        rect.setAttribute('y', geo.slotsY);
        rect.setAttribute('width', w);
        rect.setAttribute('height', 50);
        rect.setAttribute('fill', '#161616');
        rect.setAttribute('stroke', '#2a2a2a');
        rect.setAttribute('rx', '10');
        svg.appendChild(rect);

        const t1 = document.createElementNS('http://www.w3.org/2000/svg','text');
        t1.setAttribute('x', x);
        t1.setAttribute('y', geo.slotsY + 20);
        t1.setAttribute('text-anchor','middle');
        t1.setAttribute('fill','var(--muted)');
        t1.setAttribute('font-size','12');
        t1.textContent = `Slot ${s}`;
        svg.appendChild(t1);

        const t2 = document.createElementNS('http://www.w3.org/2000/svg','text');
        t2.setAttribute('x', x);
        t2.setAttribute('y', geo.slotsY + 38);
        t2.setAttribute('text-anchor','middle');
        t2.setAttribute('fill','var(--gold)');
        t2.setAttribute('font-size','12');
        t2.textContent = fmtGBP(CONFIG.payoutsGBP[s] || 0);
        svg.appendChild(t2);
      }

      // Title at top
      const topText = document.createElementNS('http://www.w3.org/2000/svg','text');
      topText.setAttribute('x', geo.W/2);
      topText.setAttribute('y', geo.m + 12);
      topText.setAttribute('text-anchor','middle');
      topText.setAttribute('fill','var(--muted)');
      topText.setAttribute('font-size','12');
      topText.textContent = 'Drop Zone';
      svg.appendChild(topText);
    }

    function renderPayoutGrid(){
      payoutGrid.innerHTML = '';
      CONFIG.payoutsGBP.forEach((val, idx)=>{
        const card = document.createElement('div');
        card.className = 'payout-card';
        const i = document.createElement('div');
        i.className = 'idx';
        i.textContent = `Slot ${idx}`;
        const v = document.createElement('div');
        v.className = 'val';
        v.textContent = fmtGBP(val);
        card.appendChild(i); card.appendChild(v);
        payoutGrid.appendChild(card);
      });
    }

    function renderPrizeForm(){
      prizeForm.innerHTML = '';
      for (let s=0; s<=CONFIG.rows; s++){
        const row = document.createElement('div'); row.className='row';
        const label = document.createElement('label'); label.textContent = `Slot ${s}`;
        const input = document.createElement('input'); input.type='number'; input.step='0.01'; input.min='0';
        input.value = Number(CONFIG.payoutsGBP[s] || 0).toFixed(2);
        input.addEventListener('input', ()=>{
          const v = parseFloat(input.value || '0') || 0;
          CONFIG.payoutsGBP[s] = v;
          // Update labels + RTP + side grid
          updatePayoutLabels();
          renderPayoutGrid();
          updatePills();
        });
        row.appendChild(label); row.appendChild(input);
        prizeForm.appendChild(row);
      }
    }

    function updatePills(){
      stakePill.textContent = `Stake: £${CONFIG.baseStakeGBP.toFixed(2)}`;
      rowsPill.textContent = `Rows: ${CONFIG.rows} (Slots: ${CONFIG.rows+1})`;
      const r = theoreticalRTP(); // expected per £1
      rtpPill.textContent = `RTP: ${(r*100).toFixed(1)}%`;
    }

    function updatePayoutLabels(){
      // Last N*3 SVG elements before topText? Safer: just rebuild labels for slots:
      // Iterate children and update the gold texts that match slot y level.
      const children = Array.from(svg.childNodes);
      children.forEach(el=>{
        if (el.nodeName === 'text'){
          const y = Number(el.getAttribute('y') || 0);
          if (Math.abs(y - (geo.slotsY + 38)) < 0.5){
            const x = Number(el.getAttribute('x') || 0);
            // Find nearest slot index by x
            let best = 0, bestDist = Infinity;
            for (let s=0; s<=geo.N; s++){
              const dx = Math.abs(x - geo.xSlot(s));
              if (dx < bestDist){ bestDist = dx; best = s; }
            }
            el.textContent = fmtGBP(CONFIG.payoutsGBP[best] || 0);
          }
        }
      });
    }

    // --- Path simulation (unbiased) ---
    function simulatePath(){
      const N = CONFIG.rows;
      const steps = [];
      for (let r=0; r<N; r++){
        const bit = (crypto.getRandomValues(new Uint8Array(1))[0] & 1) ? 1 : -1;
        steps.push(bit);
      }
      const rights = steps.filter(s=>s===1).length;
      return { steps, slotIndex: rights };
    }

    // --- Animation helpers (natural fall) ---
    function easeInQuad(t){ return t*t; }
    function easeOutQuad(t){ return t*(2-t); }
    function easeInOutQuad(t){ return t<.5 ? 2*t*t : -1+(4-2*t)*t; }
    function clamp(v,min,max){ return v<min?min:v>max?max:v; }

    function tweenBall(ball, from, to, ms, ease=easeInOutQuad, curveDown=0){
      // Optional curveDown adds a slight downward arc (gravity feel)
      return new Promise(resolve=>{
        const x0=from.x, y0=from.y, x1=to.x, y1=to.y;
        let t0=null;
        function step(ts){
          if (!t0) t0=ts;
          const p = clamp((ts - t0)/ms, 0, 1);
          const e = ease(p);
          const x = x0 + (x1 - x0)*e;
          const yLin = y0 + (y1 - y0)*e;
          const y = yLin + curveDown * Math.sin(Math.PI*e); // arc
          ball.setAttribute('cx', x);
          ball.setAttribute('cy', y);
          if (p<1) requestAnimationFrame(step);
          else resolve();
        }
        requestAnimationFrame(step);
      });
    }

    function smallBounce(ball, amp=8, ms=180){
      return new Promise(resolve=>{
        const cy0 = Number(ball.getAttribute('cy'));
        let t0=null;
        function step(ts){
          if (!t0) t0=ts;
          const p = clamp((ts - t0)/ms, 0, 1);
          const y = cy0 - amp*Math.sin(Math.PI*p)*Math.exp(-2*p);
          ball.setAttribute('cy', y);
          if (p<1) requestAnimationFrame(step);
          else resolve();
        }
        requestAnimationFrame(step);
      });
    }

    async function animateDrop(path){
      const N = geo.N;
      // Start at centre slot
      let x = geo.xSlot(Math.floor(N/2));
      let y = geo.m + 14;

      const ball = document.createElementNS('http://www.w3.org/2000/svg','circle');
      ball.setAttribute('cx', x);
      ball.setAttribute('cy', y);
      ball.setAttribute('r', CONFIG.ballRadius);
      ball.setAttribute('fill','var(--gold)');
      ball.setAttribute('opacity','0.95');
      svg.appendChild(ball);

      let rights = 0;

      for (let r=0; r<N; r++){
        // Approach the peg directly below current position (based on rights so far)
        const pegX = geo.xPeg(r, rights);
        const pegY = geo.yRow(r) - 6;

        // Fall to peg (ease-in, slight arc)
        await tweenBall(ball, {x,y}, {x:pegX, y:pegY}, 140 + r*10, easeInQuad, 10);

        // Tiny bounce on the peg
        await smallBounce(ball, 6, 140);

        // Decide direction and deflect
        const step = path.steps[r];
        if (step === 1) rights++;

        // Target midway to next row with lateral shift of half a slot
        const midX = pegX + (step * geo.colGap * 0.5);
        const midY = geo.yRow(r) + (CONFIG.rowGap * 0.55);

        // Deflect with gravity-like ease-out and curved path
        await tweenBall(ball, {x:pegX, y:pegY}, {x:midX, y:midY}, 160, easeOutQuad, 18);

        // Update current
        x = midX; y = midY;
      }

      // Final fall into the computed slot
      const slotIndex = path.slotIndex;
      const targetX = geo.xSlot(slotIndex);
      const targetY = geo.slotsY + 34;

      await tweenBall(ball, {x,y}, {x:targetX, y:targetY}, 260, easeInQuad, 24);
      await smallBounce(ball, 10, 220);

      // Result + stats
      const prize = Number(CONFIG.payoutsGBP[slotIndex] || 0);
      session.drops += 1;
      session.winnings += prize;
      updateStatsUI();
      highlightSlot(slotIndex);
      showToast(prize>0 ? `Win: ${fmtGBP(prize)} (Slot ${slotIndex})` : `No prize (Slot ${slotIndex})`);

      // Fade ball
      await new Promise(res=>{
        let t0=null; function f(t){ if(!t0)t0=t; const p=Math.min(1,(t-t0)/500); ball.setAttribute('opacity', String(0.95*(1-p))); if(p<1) requestAnimationFrame(f); else res(); }
        requestAnimationFrame(f);
      });
      svg.removeChild(ball);
    }

    function highlightSlot(idx, duration=600){
      const x = geo.xSlot(idx), w = geo.colGap*0.92;
      const g = document.createElementNS('http://www.w3.org/2000/svg','rect');
      g.setAttribute('x', x - w/2);
      g.setAttribute('y', geo.slotsY);
      g.setAttribute('width', w);
      g.setAttribute('height', 50);
      g.setAttribute('rx','10');
      g.setAttribute('fill','none');
      g.setAttribute('stroke','var(--gold)');
      g.setAttribute('stroke-width','2.5');
      g.setAttribute('opacity','0.0');
      svg.appendChild(g);
      let t0 = null;
      function anim(t){
        if (!t0) t0 = t;
        const p = Math.min(1,(t - t0)/duration);
        g.setAttribute('opacity', String(0.9*(1-p)));
        if (p<1) requestAnimationFrame(anim);
        else svg.removeChild(g);
      }
      requestAnimationFrame(anim);
    }

    function updateStatsUI(){
      statDrops.textContent = session.drops;
      statWinnings.textContent = fmtGBP(session.winnings);
      const spent = session.drops * CONFIG.baseStakeGBP;
      const rtp = spent > 0 ? (session.winnings / spent)*100 : 0;
      statSessionRTP.textContent = (rtp).toFixed(1) + '%';
    }

    // Wire UI
    drop1.addEventListener('click', ()=> drop());
    drop3.addEventListener('click', ()=> { drop(); drop(); drop(); });
    resetBtn.addEventListener('click', ()=>{
      session = { drops: 0, winnings: 0 };
      updateStatsUI();
      buildBoard();
      renderPayoutGrid();
      updatePayoutLabels();
    });

    async function drop(){
      if (busy){ queue++; return; }
      busy = true;
      try{
        const path = simulatePath();    // MVP: client RNG
        await animateDrop(path);
      } finally {
        busy = false;
        if (queue>0){ queue--; drop(); }
      }
    }

    // Init
    (function init(){
      if (CONFIG.payoutsGBP.length !== CONFIG.rows+1) {
        // pad/trim to correct length
        const target = CONFIG.rows+1;
        const arr = new Array(target).fill(0);
        for (let i=0;i<Math.min(target, CONFIG.payoutsGBP.length);i++) arr[i]=CONFIG.payoutsGBP[i];
        CONFIG.payoutsGBP = arr;
      }
      buildBoard();
      renderPayoutGrid();
      renderPrizeForm();
      updatePills();
      updateStatsUI();
    })();
  </script>
</body>
</html>
